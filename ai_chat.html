<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Spline+Sans%3Awght%40400%3B500%3B700"
    />
    

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: "Spline Sans", "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        
        <div id="header-placeholder"></div>

        <div class="px-4 md:px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <h2 class="text-[#111418] tracking-light text-2xl md:text-[28px] font-bold leading-tight px-4 text-center pb-3 pt-5">AI Analysis Summary</h2>
            <p class="text-[#111418] text-base font-normal leading-normal pb-3 pt-1 px-4 text-center">
              Based on the information you provided, the person you're interested in is likely to be interested in the latest trends in technology and artificial intelligence. They
              may also enjoy discussions about innovative startups and the future of work.
            </p>
            <h2 class="text-[#111418] text-xl md:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Chat with AI</h2>
            
            <div id="chat-container" class="flex flex-col gap-4 p-4 h-96 overflow-y-auto border rounded-lg mb-4">
              <!-- AI의 첫 인사 메시지 -->
              <div class="flex items-end gap-3">
                <div
                  class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAm0_lLVCpj8mkydB_N7I5Tp62KPh7naPP69vD6x5x0bDx0kbHKRS_T6g2IQCgr_dgCbP1j0m5SDfJoMab8Z3m1y5w_Kwz3_Ty7Ht9rpSX3yBLpxtMyqfGqxkClDyY5Y72tYoKRbeUYmsFtCol8dlcqPZBChn5igQhi55092xNosRDeIOhoOft3V6PzVkXS0G1oGqo8I9Cp3MvZWzlqT8jckXOa8iC3EMz0-BZEJP53XWtU5QtB3iOS9MHW4r5WYhIgoLba_oQlHQ");'
                ></div>
                <div class="flex flex-1 flex-col gap-1 items-start">
                  <p class="text-[#60758a] text-[13px] font-normal leading-normal max-w-[360px]">AI Assistant</p>
                  <p class="text-base font-normal leading-normal flex max-w-[360px] rounded-xl px-4 py-3 bg-[#f0f2f5] text-[#111418]">
                    Hello! I'm here to help you practice conversations based on the analysis. How can I assist you today?
                  </p>
                </div>
              </div>
            </div>

            <!-- 메시지 입력창 -->
            <div class="flex items-center px-4 py-3 gap-3 @container">
              <label class="flex flex-col min-w-40 h-12 flex-1">
                <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                  <input
                    id="chat-input"
                    placeholder="Type your message..."
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f5] focus:border-none h-full placeholder:text-[#60758a] px-4 rounded-r-none border-r-0 pr-2 text-base font-normal leading-normal"
                    value=""
                  />
                  <div class="flex border-none bg-[#f0f2f5] items-center justify-center pr-4 rounded-r-xl border-l-0 !pr-2">
                    <div class="flex items-center gap-4 justify-end">
                      <div class="flex items-center gap-1">
                        <button class="flex items-center justify-center p-1.5 rounded-full transition-colors duration-200 hover:bg-gray-200">
                          <div class="text-[#60758a]" data-icon="Image" data-size="20px" data-weight="regular">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                              <path
                                d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-26.07-26.06a16,16,0,0,0-22.63,0l-20,20-44-44a16,16,0,0,0-22.62,0L40,149.37V56ZM40,172l52-52,80,80H40Zm176,28H194.63l-36-36,20-20L216,181.38V200ZM144,100a12,12,0,1,1,12,12A12,12,0,0,1,144,100Z"
                              ></path>
                            </svg>
                          </div>
                        </button>
                        <button id="mic-button" class="flex items-center justify-center p-1.5 rounded-full transition-colors duration-200 hover:bg-gray-200">
                          <div class="text-[#60758a]" data-icon="Microphone" data-size="20px" data-weight="regular">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                              <path
                                d="M128,176a48.05,48.05,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48.05,48.05,0,0,0,128,176ZM96,64a32,32,0,0,1,64,0v64a32,32,0,0,1-64,0Zm40,143.6V232a8,8,0,0,1-16,0V207.6A80.11,80.11,0,0,1,48,128a8,8,0,0,1,16,0,64,64,0,0,0,128,0,8,8,0,0,1,16,0A80.11,80.11,0,0,1,136,207.6Z"
                              ></path>
                            </svg>
                          </div>
                        </button>
                      </div>
                      <button
                        id="send-button"
                        class="min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#1466b8] text-white text-sm font-medium leading-normal hidden @[480px]:block transition-all duration-200 ease-out hover:bg-[#1a73c8]"
                      >
                        <span class="truncate">Send</span>
                      </button>
                    </div>
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>
        
        <div id="footer-placeholder"></div>
      </div>
    </div>

    <script src="loadComponents.js"></script>
    <script>
      document.addEventListener('componentsLoaded', () => {
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;
        let final_transcript = '';
        // *** 수정된 부분: 제안해주신 재시작 제어 플래그 ***
        let shouldRestart = false; 

        const addMessage = (message, isUser = false) => {
          const messageWrapper = document.createElement('div');
          
          if (isUser) {
            messageWrapper.className = 'flex items-end gap-3 justify-end';
            messageWrapper.innerHTML = `
              <div class="flex flex-1 flex-col gap-1 items-end">
                <p class="text-base font-normal leading-normal flex max-w-[360px] rounded-xl px-4 py-3 bg-[#1466b8] text-white">
                  ${message}
                </p>
              </div>
            `;
          } else {
            messageWrapper.className = 'flex items-end gap-3';
            messageWrapper.innerHTML = `
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAm0_lLVCpj8mkydB_N7I5Tp62KPh7naPP69vD6x5x0bDx0kbHKRS_T6g2IQCgr_dgCbP1j0m5SDfJoMab8Z3m1y5w_Kwz3_Ty7Ht9rpSX3yBLpxtMyqfGqxkClDyY5Y72tYoKRbeUYmsFtCol8dlcqPZBChn5igQhi55092xNosRDeIOhoOft3V6PzVkXS0G1oGqo8I9Cp3MvZWzlqT8jckXOa8iC3EMz0-BZEJP53XWtU5QtB3iOS9MHW4r5WYhIgoLba_oQlHQ");'></div>
              <div class="flex flex-1 flex-col gap-1 items-start">
                <p class="text-[#60758a] text-[13px] font-normal leading-normal max-w-[360px]">AI Assistant</p>
                <p class="text-base font-normal leading-normal flex max-w-[360px] rounded-xl px-4 py-3 bg-[#f0f2f5] text-[#111418]">
                  ${message}
                </p>
              </div>
            `;
          }
          
          chatContainer.appendChild(messageWrapper);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const aiResponse = () => {
          setTimeout(() => {
            addMessage("That's a great topic! Tell me more about your thoughts on that.", false);
          }, 1000);
        };

        // *** 수정된 부분: 제안해주신 sendMessage 로직 ***
        const sendMessage = () => {
          const message = chatInput.value.trim();
          if (message) {
            addMessage(message, true);
            chatInput.value = '';
            final_transcript = ''; 
            aiResponse();

            if (isListening && recognition) {
              shouldRestart = true;
              isListening = false;
              recognition.stop();
            }
          }
        };

        sendButton.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && !event.isComposing) {
            event.preventDefault();
            sendMessage();
          }
        });

        // 음성 인식 기능
        if (micButton && SpeechRecognition) {
          recognition = new SpeechRecognition();
          const micIconDiv = micButton.querySelector('div');

          recognition.lang = 'ko-KR';
          recognition.interimResults = true;
          recognition.continuous = true;

          recognition.onstart = () => {
            micButton.classList.add('bg-blue-100');
            micIconDiv.classList.remove('text-[#60758a]');
            micIconDiv.classList.add('text-blue-600');
          };

          // *** 수정된 부분: 제안해주신 onend 로직 ***
          recognition.onend = () => {
            if (shouldRestart) {
              shouldRestart = false;
              isListening = true; 
              recognition.start();
            } else {
              micButton.classList.remove('bg-blue-100');
              micIconDiv.classList.add('text-[#60758a]');
              micIconDiv.classList.remove('text-blue-600');
            }
          };

          recognition.onresult = (event) => {
            let interim_transcript = '';
            let final_transcript_result = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) {
                final_transcript_result += event.results[i][0].transcript;
              } else {
                interim_transcript += event.results[i][0].transcript;
              }
            }
            final_transcript += final_transcript_result;
            chatInput.value = final_transcript + interim_transcript;
          };

          recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            isListening = false;
          };

          micButton.addEventListener('click', () => {
            if (isListening) {
              isListening = false;
              recognition.stop();
            } else {
              isListening = true;
              chatInput.value = '';
              final_transcript = '';
              recognition.start();
              chatInput.focus();
            }
          });

        } else if (micButton) {
          micButton.addEventListener('click', () => {
            alert('사용하시는 브라우저는 음성 인식을 지원하지 않습니다.');
          });
        }
      });
    </script>
  </body>
</html>